name: Guard Rails - Code Quality

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:

jobs:
  code-quality:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install Dependencies
        run: |
          if [ -f "package-lock.json" ]; then
            npm ci --legacy-peer-deps
          else
            npm install --legacy-peer-deps
            npm install --package-lock-only
          fi

      - name: Verify ESLint Config
        run: |
          if [ ! -f "eslint.config.mts" ] && [ ! -f ".eslintrc.js" ] && [ ! -f ".eslintrc.json" ]; then
            echo "‚ùå No ESLint configuration found"
            exit 1
          fi
          echo "‚úÖ ESLint configuration found"

      - name: Run ESLint
        run: |
          echo "üîç Running ESLint on project directories..."
          npx eslint "app-updater/**/*.js" "AppBuild/**/*.js" "Core/**/*.js" "Scripts/**/*.js" "infra/**/*.js" --max-warnings 0
          echo "‚úÖ ESLint passed"

      - name: Check Prettier Format
        run: |
          echo "üé® Checking code formatting with Prettier..."
          npx prettier --check "app-updater/**/*.js" "AppBuild/**/*.js" "Core/**/*.js" "Scripts/**/*.js" "infra/**/*.js" ".github/**/*.yml" "*.json" "*.md" || {
            echo "‚ö†Ô∏è Prettier check found formatting issues"
            echo "üí° Run 'npm run format' to fix formatting issues"
            exit 1
          }
          echo "‚úÖ Prettier check passed"
